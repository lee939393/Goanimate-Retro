(function(e){var f=function(g){var h=this;this.template='<div class="aside-block"><div class="header"><button class="close">&#215;</button><h3>'+GT.gettext("Revision History")+'</h3></div><div class="content"></div></div>';this.$el=e(this.template);this.movieId=g;this.revisionTS="";this.$el.on("click",".close",function(i){i.preventDefault();h.hide()});this.initialize()};f.prototype={initialize:function(){this.show();this.loadRevisions(this.movieId)},loadRevisions:function(){var i=this,h="/ajax/getMovieRevisionList/"+this.movieId,g=this.$el.find(".content");g.addClass("loading");e.post(h,function(k){if(!k.length){return}var j=i.renderRevisions(k);g.removeClass("loading").append(j)},"json")},renderRevisions:function(i){var h=this,g=e('<ol class="revisions"></ol>');e.each(i,function(l,k){var j=e('<li class="revision"></li>').data("timestamp",k.timestamp);if(k.type=="current"){h.revisionTS=k.timestamp;j.addClass("active")}j.append(e("<strong></strong>").text(k.EST));if(k.type=="autosave"){j.append('<br><small class="autosave">autosave</small>')}else{j.append("<br><small>saved by you</small>")}j.append('<div class="actions dimmed"><a class="play" href="#"><i class="ico-play"></i></a> <a class="edit" href="#"><i class="ico-edit"></i></a> <a class="copy" href="#"><i class="ico-copy"></i></a></div>');j.on("click",function(m){if(j.hasClass("active")){return false}h.setPlayer(k.timestamp,k.type,false);g.find(".active").removeClass("active");j.addClass("active")}).on("click",".edit",function(m){m.preventDefault();m.stopPropagation();if(k.type=="autosave"){fullscreenStudio("/videomaker/full/editasrevision/"+h.movieId+"/"+k.timestamp)}else{fullscreenStudio("/videomaker/full/editrevision/"+h.movieId+"/"+k.timestamp)}}).on("click",".copy",function(m){m.preventDefault();m.stopPropagation();if(k.type=="autosave"){fullscreenStudio("/videomaker/full/copyasrevision/"+h.movieId+"/"+k.timestamp)}else{fullscreenStudio("/videomaker/full/copyrevision/"+h.movieId+"/"+k.timestamp)}}).on("click",".play",function(m){m.preventDefault();m.stopPropagation();h.setPlayer(k.timestamp,k.type,true);g.find(".active").removeClass("active");j.addClass("active")}).appendTo(g)});return g},setPlayer:function(i,k,h){var l=e("#playerdiv object param[name='flashvars']");var j=l.attr("value");if(h==true){if(j.search("&autostart=")==-1){j+="&autostart=1"}j=j.replace("&autostart=0","&autostart=1")}else{if(j.search("&autostart=")==-1){j+="&autostart=0"}j=j.replace("&autostart=1","&autostart=0")}if(j.search("&revaction=")!=-1){j=j.substr(0,j.search("&revaction="))}if(k=="autosave"){j+="&revaction=e&revts="+i+"&revtype=a"}else{j+="&revaction=e&revts="+i+"&revtype=m"}l.attr("value",j);var g=e("#playerdiv object").clone();e("#playerdiv object").remove();g.appendTo("#playerdiv")},show:function(){e("#video-page").addClass("player-expand");e("#player-aside").empty().append(this.$el)},hide:function(){e("#player-aside").empty();e("#video-page").removeClass("player-expand");if(this.revisionTS!=""){this.setPlayer(this.revisionTS,"current",false)}e(document).trigger("revisionHistoryHidden")}};var a=function(g){var h=this;this.$el=g;this.$el.click(function(k){var j=e(this),i=j.data("userId");k.preventDefault();if(j.hasClass("not-following")){h.follow(i)}else{if(j.hasClass("following")){h.unfollow(i)}}}).mouseleave(function(){e(this).removeClass("cancel-hover")})};a.prototype={follow:function(h){var i=this,g="/ajax/becomeFan/"+h;e.post(g,function(j){parseResponse(j);if(responseArray.code=="0"){i.setState("following");i.$el.addClass("cancel-hover")}resetResponse()})},unfollow:function(h){var i=this,g="/ajax/removeIdol/"+h;e.post(g,function(j){parseResponse(j);if(responseArray.code=="0"){i.setState("not-following")}resetResponse()})},setState:function(g){this.$el.removeClass("following not-following").addClass(g)}};var c={follow:function(h,j){var i=this,g="/ajax/becomeFan/"+h;e.post(g,function(k){parseResponse(k);if(responseArray.code=="0"){if(j){i.setState(j,"following")}}resetResponse()})},unfollow:function(h,j){var i=this,g="/ajax/removeIdol/"+h;e.post(g,function(k){parseResponse(k);if(responseArray.code=="0"){if(j){i.setState(j,"not-following")}}resetResponse()})},setState:function(g,h){g.removeClass("following not-following").addClass(h)}};var b=function(g){var h=this;this.$el=g;this.$el.click(function(k){var j=e(this),i=j.data("video");k.preventDefault();if(j.hasClass("not-liked")){h.like(i)}else{if(j.hasClass("liked")){h.unlike(i)}}}).mouseleave(function(){e(this).removeClass("cancel-hover")})};b.prototype={like:function(i){var h=this,g="/ajax/movie_recommend";e.post(g,{movie_id:i},function(j){parseResponse(j);if(responseArray.code=="0"){h.setState("liked");h.$el.addClass("cancel-hover")}resetResponse()})},unlike:function(i){var h=this,g="/ajax/deleteFavorite/"+i;e.post(g,function(j){parseResponse(j);if(responseArray.code=="0"){h.setState("not-liked")}resetResponse()})},setState:function(g){this.$el.removeClass("liked not-liked").addClass(g)}};var d=function(g){var h=this;this.$el=e(g);this.revisionHistory=null;e(document).on("published","#video-share",function(j,i){h.updateInfo(i)}).on("saved","#video-settings",function(j,i){h.updateInfo(i)}).on("commentPosted",function(){e(".num-commented").html(number_format(parseInt(e(".num-commented").html(),10)+1))}).on("commentDeleted",function(){e(".num-commented").html(number_format(parseInt(e(".num-commented").html(),10)-1))}).on("videoDeleted",function(){window.location="/myvideos"}).on("click",'[data-action="video-revisions"]',function(k){var j=e(this),i=j.data("video");k.preventDefault();e("#video-edit").modal("hide");if(!h.revisionHistory){h.revisionHistory=new f(i)}}).on("revisionHistoryHidden",function(){delete h.revisionHistory})};d.prototype={updateInfo:function(g){this.$el.find(".video-header .status").attr("class","status "+g.status);this.$el.find(".video-header h1").text(g.title)}};e(document).ready(function(){e(".follow-button").each(function(){var j=e(this);if(!j.data("followButton")){j.data("followButton",new a(j))}});e(".favorite-button").each(function(){var j=e(this);if(!j.data("favoriteButton")){j.data("favoriteButton",new b(j))}});var i=new d("#video-page");if(typeof hasRevisionHistory!="undefined"&&hasRevisionHistory==true&&typeof revisionEncMovieId!="undefined"){var h=new f(revisionEncMovieId)}e('[rel="tooltip"]').tooltip();function g(l,j,k){e(l).addClass("loading");e.post(j,{page:k},function(m){e.scrollTo(l,{duration:200,offset:{top:-20}});e(l).replaceWith(m)})}e("#video-favorites").on("click","[data-page]",function(n){var m=e(this),k=m.data("page"),l=m.closest(".go-pagination").data("target"),j=m.closest(".go-pagination").data("endPoint");n.preventDefault();if(m.parent().hasClass("disabled")){return}g(l,j,k)}).on("submit",".go-pagination-form",function(n){var m=e(this),k=parseInt(m.find('input[name="page"]').val(),10),l=m.closest(".go-pagination").data("target"),j=m.closest(".go-pagination").data("endPoint");n.preventDefault();if(k<=0||k>m.data("maxPage")){alert(GT.gettext("Please input a valid page number"));return}g(l,j,k)})}).on("click",".user-follow-button",function(i){var h=e(this),g=h.data("userId");i.preventDefault();if(h.hasClass("not-following")){c.follow(g,h)}else{if(h.hasClass("following")){c.unfollow(g,h)}}})})(jQuery);var URL_STAFFPICKS_MOVIE="/ajax/addStaffpicksMovie";var URL_ADD_BEST_ANIMATION="/ajax/addBestAnimation";var URL_ADD_FEATUED_ANIMATION="/ajax/addFeaturedAnimation";var URL_REJECT_MOVIE="/ajax/rejectMovie";var URL_SET_TITLE_PREFIX="/ajax/setMovieTitlePrefix";function staffpicksMovie(a){var b="Are you sure to Staffpicks this video?";if(!confirm(b)){return}$.post(URL_STAFFPICKS_MOVIE+"/"+a,function(c){parseResponse(c);if(typeof responseArray.json.url!="undefined"){window.location=responseArray.json.url}else{if(responseArray.code=="0"){displayFeedback(responseArray.code+"The video has been added to Staffpicks")}else{displayFeedback(responseArray.code+responseArray.json.error)}}resetResponse()})}function addBestAnimation(a){var b="Are you sure to add this video as one of the best animations?";if(!confirm(b)){return}$.post(URL_ADD_BEST_ANIMATION+"/"+a,function(c){parseResponse(c);if(typeof responseArray.json.url!="undefined"){window.location=responseArray.json.url}else{if(responseArray.code=="0"){displayFeedback(responseArray.code+"The video is one of the best animations now")}else{displayFeedback(responseArray.code+responseArray.json.error)}}resetResponse()})}function featureAnimation(a){var b="Are you sure to feature this video?";if(!confirm(b)){return}$.post(URL_ADD_FEATUED_ANIMATION+"/"+a,function(c){parseResponse(c);if(typeof responseArray.json.url!="undefined"){window.location=responseArray.json.url}else{if(responseArray.code=="0"){displayFeedback(responseArray.code+"The video has been added as featured animation")}else{displayFeedback(responseArray.code+responseArray.json.error)}}resetResponse()})}function rejectMovie(b){var c="Are you sure you want to reject this video?";if(!confirm(c)){return}var a=URL_REJECT_MOVIE+"/"+b;jQuery.post(a,function(d){parseResponse(d);if(typeof responseArray.json.url!="undefined"){window.location=responseArray.json.url}else{if(responseArray.code=="0"){displayFeedback(responseArray.code+"Video has been rejected")}else{displayFeedback(responseArray.code+responseArray.json.error)}}resetResponse()})}function setMovieTitlePrefix(b){if(typeof MOVIE_TITLE==="undefined"||typeof MOVIE_USERNAME==="undefined"||typeof MOVIE_TITLE_PREFIX==="undefined"){return false}var e=MOVIE_TITLE+" - "+MOVIE_USERNAME;var d=MOVIE_TITLE_PREFIX;var c=prompt("Enter title prefix for this movie",d);if(c!=null&&c!=d){var a=URL_SET_TITLE_PREFIX+"/"+b;jQuery.post(a,{prefix:c},function(f){parseResponse(f);if(responseArray.code=="0"){displayFeedback(responseArray.code+"Title prefix has been updated.");MOVIE_TITLE_PREFIX=c;document.title=(c!="")?c+" - "+e:e}else{displayFeedback(responseArray.code+responseArray.json.error)}resetResponse()})}};
